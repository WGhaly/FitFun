<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - FitFun</title>
    <meta name="description" content="View your progress and analytics">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../../styles/design-system.css">
    <link rel="stylesheet" href="../../styles/layout.css">
    <link rel="stylesheet" href="../../styles/components.css">

    <style>
        body {
            background: var(--color-background);
        }

        .page-header {
            background: var(--gradient-hero);
            color: white;
            padding: var(--space-8) 0;
            margin-bottom: var(--space-8);
        }

        .page-header h1 {
            font-family: var(--font-heading);
            font-size: var(--text-4xl);
            font-weight: 800;
            margin-bottom: var(--space-2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }

        .stat-card {
            background: white;
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-3xl);
            margin-bottom: var(--space-4);
        }

        .stat-card-icon.primary {
            background: var(--color-primary-light);
        }

        .stat-card-icon.success {
            background: var(--color-success-light);
        }

        .stat-card-icon.warning {
            background: var(--color-warning-light);
        }

        .stat-card-value {
            font-size: var(--text-4xl);
            font-weight: 800;
            color: var(--color-text);
            margin-bottom: var(--space-2);
        }

        .stat-card-label {
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            font-weight: 500;
        }

        .stat-card-change {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: 600;
            margin-top: var(--space-2);
        }

        .stat-card-change.positive {
            background: var(--color-success-light);
            color: var(--color-success);
        }

        .stat-card-change.negative {
            background: var(--color-error-light);
            color: var(--color-error);
        }

        .chart-card {
            background: white;
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }

        .chart-card h3 {
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: var(--space-4);
        }

        .progress-timeline {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .timeline-item {
            display: flex;
            gap: var(--space-4);
            padding: var(--space-4);
            background: var(--color-background);
            border-radius: var(--radius-lg);
        }

        .timeline-date {
            font-weight: 600;
            color: var(--color-primary);
            min-width: 100px;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-value {
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--color-text);
        }

        .timeline-change {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-4);
        }

        .achievement-card {
            background: var(--color-background);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: var(--space-2);
        }

        .achievement-title {
            font-weight: 600;
            font-size: var(--text-sm);
            color: var(--color-text);
            margin-bottom: var(--space-1);
        }

        .achievement-desc {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-12);
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="home.html" class="navbar-brand">FitFun</a>

            <button class="navbar-toggle" id="navbar-toggle">‚ò∞</button>

            <ul class="navbar-menu" id="navbar-menu">
                <li><a href="home.html" class="navbar-link">Home</a></li>
                <li><a href="dashboard.html" class="navbar-link">Dashboard</a></li>
                <li><a href="profile.html" class="navbar-link">Profile</a></li>
                <li><a href="analytics.html" class="navbar-link active">Analytics</a></li>
                <li><button class="btn btn-sm btn-outline" id="logout-btn">Logout</button></li>
            </ul>
        </div>
    </nav>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1>üìä Your Analytics</h1>
            <p>Track your progress and achievements</p>
        </div>
    </section>

    <!-- Main Content -->
    <main class="page-content">
        <div class="container" style="max-width: 1200px;">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-icon primary">üèÜ</div>
                    <div class="stat-card-value" id="total-competitions">0</div>
                    <div class="stat-card-label">Competitions Joined</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-icon success">‚úÖ</div>
                    <div class="stat-card-value" id="completed-competitions">0</div>
                    <div class="stat-card-label">Completed</div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-icon warning">‚öñÔ∏è</div>
                    <div class="stat-card-value" id="total-weight-lost">0 kg</div>
                    <div class="stat-card-label">Total Weight Lost</div>
                    <span class="stat-card-change positive" id="weight-change">+0 kg this month</span>
                </div>

                <div class="stat-card">
                    <div class="stat-card-icon primary">üéØ</div>
                    <div class="stat-card-value" id="win-rate">0%</div>
                    <div class="stat-card-label">Win Rate</div>
                </div>
            </div>

            <!-- Weight Progress Chart -->
            <div class="chart-card">
                <h3>Weight Progress</h3>
                <div id="weight-progress">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        <p>No weight measurements yet. Start tracking your progress!</p>
                    </div>
                </div>
            </div>

            <!-- Competition History -->
            <div class="chart-card">
                <h3>Competition History</h3>
                <div class="progress-timeline" id="competition-history">
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÉ</div>
                        <p>No competition history yet. Join a competition to get started!</p>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div class="chart-card">
                <h3>Achievements</h3>
                <div class="achievements-grid" id="achievements">
                    <!-- Achievements will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../../js/api.js"></script>
    <script src="../../js/state.js"></script>
    <script src="../../js/utils.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/competition.js"></script>
    <script src="../../js/ui.js"></script>

    <script>
        // Check authentication
        if (!Auth.isAuthenticated()) {
            window.location.href = '../auth/login.html';
        }

        const currentUser = Auth.getCurrentUser();

        // Mobile menu toggle
        document.getElementById('navbar-toggle').addEventListener('click', () => {
            document.getElementById('navbar-menu').classList.toggle('active');
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            Auth.logout();
            window.location.href = '../auth/login.html';
        });

        // Load analytics data
        function loadAnalytics() {
            const state = State.getState();
            const competitions = state.competitions || [];
            const measurements = state.measurements || [];

            // Get user's competitions
            const userCompetitions = competitions.filter(c =>
                c.participants && c.participants.includes(currentUser.id)
            );

            const completedCompetitions = userCompetitions.filter(c => c.status === 'completed');
            const wonCompetitions = completedCompetitions.filter(c => {
                if (!c.winners) return false;
                return c.winners.some(w => w.userId === currentUser.id);
            });

            // Update stats
            document.getElementById('total-competitions').textContent = userCompetitions.length;
            document.getElementById('completed-competitions').textContent = completedCompetitions.length;

            // Calculate total weight lost
            const userMeasurements = measurements.filter(m => m.userId === currentUser.id);
            let totalWeightLost = 0;
            if (userMeasurements.length > 1) {
                const sortedMeasurements = userMeasurements.sort((a, b) =>
                    new Date(a.measurementDate) - new Date(b.measurementDate)
                );
                const firstWeight = sortedMeasurements[0].weight;
                const lastWeight = sortedMeasurements[sortedMeasurements.length - 1].weight;
                totalWeightLost = Math.max(0, firstWeight - lastWeight);
            }
            document.getElementById('total-weight-lost').textContent = `${totalWeightLost.toFixed(1)} kg`;

            // Win rate
            const winRate = completedCompetitions.length > 0
                ? ((wonCompetitions.length / completedCompetitions.length) * 100).toFixed(0)
                : 0;
            document.getElementById('win-rate').textContent = `${winRate}%`;

            // Load weight progress
            loadWeightProgress(userMeasurements);

            // Load competition history
            loadCompetitionHistory(userCompetitions);

            // Load achievements
            loadAchievements(userCompetitions, wonCompetitions, totalWeightLost);
        }

        function loadWeightProgress(measurements) {
            const container = document.getElementById('weight-progress');

            if (measurements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìà</div>
                        <p>No weight measurements yet. Start tracking your progress!</p>
                    </div>
                `;
                return;
            }

            const sortedMeasurements = measurements.sort((a, b) =>
                new Date(a.measurementDate) - new Date(b.measurementDate)
            );

            container.innerHTML = `
                <div class="progress-timeline">
                    ${sortedMeasurements.map((m, index) => {
                const change = index > 0
                    ? sortedMeasurements[index - 1].weight - m.weight
                    : 0;
                const changeText = change > 0
                    ? `‚Üì ${change.toFixed(1)} kg`
                    : change < 0
                        ? `‚Üë ${Math.abs(change).toFixed(1)} kg`
                        : 'No change';

                return `
                            <div class="timeline-item">
                                <div class="timeline-date">${Utils.formatDate(m.measurementDate)}</div>
                                <div class="timeline-content">
                                    <div class="timeline-value">${m.weight} kg</div>
                                    ${index > 0 ? `<div class="timeline-change">${changeText}</div>` : ''}
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        function loadCompetitionHistory(competitions) {
            const container = document.getElementById('competition-history');

            if (competitions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÉ</div>
                        <p>No competition history yet. Join a competition to get started!</p>
                    </div>
                `;
                return;
            }

            const sortedCompetitions = competitions.sort((a, b) =>
                new Date(b.startDate) - new Date(a.startDate)
            );

            container.innerHTML = sortedCompetitions.map(c => {
                const statusEmoji = {
                    'upcoming': '‚è≥',
                    'active': 'üî•',
                    'completed': '‚úÖ',
                    'canceled': '‚ùå'
                };

                return `
                    <div class="timeline-item">
                        <div class="timeline-date">${statusEmoji[c.status]} ${c.status.toUpperCase()}</div>
                        <div class="timeline-content">
                            <div class="timeline-value">${c.name}</div>
                            <div class="timeline-change">
                                Started: ${Utils.formatDate(c.startDate)} ‚Ä¢ ${c.participants.length} participants
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadAchievements(competitions, wonCompetitions, totalWeightLost) {
            const achievements = [];

            // First competition
            if (competitions.length > 0) {
                achievements.push({
                    icon: 'üéØ',
                    title: 'First Step',
                    desc: 'Joined your first competition'
                });
            }

            // First win
            if (wonCompetitions.length > 0) {
                achievements.push({
                    icon: 'üèÜ',
                    title: 'Champion',
                    desc: 'Won your first competition'
                });
            }

            // Weight loss milestones
            if (totalWeightLost >= 5) {
                achievements.push({
                    icon: '‚≠ê',
                    title: '5kg Milestone',
                    desc: 'Lost 5kg or more'
                });
            }

            if (totalWeightLost >= 10) {
                achievements.push({
                    icon: 'üåü',
                    title: '10kg Milestone',
                    desc: 'Lost 10kg or more'
                });
            }

            // Competition participation
            if (competitions.length >= 5) {
                achievements.push({
                    icon: 'üí™',
                    title: 'Dedicated',
                    desc: 'Joined 5+ competitions'
                });
            }

            if (competitions.length >= 10) {
                achievements.push({
                    icon: 'üî•',
                    title: 'Super Active',
                    desc: 'Joined 10+ competitions'
                });
            }

            const container = document.getElementById('achievements');

            if (achievements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèÖ</div>
                        <p>Start your journey to unlock achievements!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = achievements.map(a => `
                <div class="achievement-card">
                    <div class="achievement-icon">${a.icon}</div>
                    <div class="achievement-title">${a.title}</div>
                    <div class="achievement-desc">${a.desc}</div>
                </div>
            `).join('');
        }

        // Load analytics on page load
        loadAnalytics();
    </script>
</body>

</html>